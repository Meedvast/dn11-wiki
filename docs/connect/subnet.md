# 子网并入

## 简介

将你的子网并入DN11意味着你的子网下的设备将直接被暴露在DN11中的

出于安全性考虑，在接入前，请检查你子网下的所有服务的使用权限，除非你有意公开这些服务，请确保他们有密码/秘钥等手段保护

由于目前DN11大部分节点都采用的openwrt，本教程基于openwrt编写

## 步骤

### 检查硬件设备

检查你的网关设备是否支持wireguard

::: tip
目前DN11仅支持通过wireguard接入，后续会开放其他接入方式
:::

对于openwrt，请检查`状态-WireGuard状态`是否存在，若不存在请考虑更换固件。具体更换什么固件可以向群友求助获得编译好的固件也可以自行编译。

### 申请网段

目前网段的申请放在[qq群](https://jq.qq.com/?_wv=1027&k=wlfajEoS)内的一个腾讯文档内，一般可以申请到一个/24的网段

申请时请注意不要与他人的网段重叠，以免造成不可知的影响

### 切换网段

你需要将你设备的网段切换到申请到的网段

::: danger
如果你是新手，更建议全部推倒重新配置

如果确定要切换，请务必在大佬指导下操作，不然容易寄
:::

由于不同的人有不同网络环境，比较复杂，这里仅简单描述

#### 修改静态IP设备的IP

将除主路由外的所有需要静态IP地址的设备的IP修改到新网段

修改完成后这些设备将无法访问，但这是暂时的，无须担心

::: tip
如果使用了旁路由，请先将网关临时改回主路由，暂时停用旁路由，将旁路由作为一个普通的静态ip分配设备操作
:::

#### 修改主路由IP与DHCP

修改主路由IP与DHCP，openwrt主路由的请修改lan口相关配置

##### 网段划分建议

- 静态IP池：172.16.X.0/26
- DHCP池：172.16.X.64/26
- 外部IP池：172.16.X.128/26
- 备用：172.16.X.192/26

当然你也可以用自己喜欢的方式划分网段，毕竟这是你自己的网络

分配IP时,不要占用.255和.0

##### 配置建议

- IP：`172.16.X.1`
- 子网掩码：`255.255.255.0`
- DHCP池（建议）：172.16.X.64/26

### 生成密钥对

在安装有WireGuard的设备上输入以下指令生成一个秘钥

`wg genkey`

可以使用openwrt的shell

该命令会输出一串base64字符串，这就是你的**私钥**，请复制并妥善保管

### 添加接口并配置防火墙

#### 创建并配置接口

在`网络-接口-添加新接口...`里创建新接口

- 名称（建议）：`dn11`
- 新接口协议：`WireGuard VPN`

完成创建后，点击`修改`，修改你新建的接口，在基本设置中填入

- 私钥：填入你在上一步生成的私钥
- 监听端口：随意，不建议用过低的端口和特殊端口
- IP地址：该设备地址，一般填入`172.16.X.1/24`

然后在防火墙设置（在接口的基本设置右边）中选择不指定或新建，右边填入DN11，这一步将新建一个名为DN11的新防火墙区域

#### 配置防火墙

##### 配置区域

在 `网络-防火墙-区域` ，点击DN11的修改，对DN11区域进行修改

- 入站数据：接受
- 出站数据：接受
- 转发：接受
- 允许转发到：lan，wan
- 允许从源区域转发：lan，wan

> 如果你在配置旁路由，没有wan

##### 打开端口

点击 `防火墙-通信规则-打开路由器接口-添加`

- 名称（建议）：dn11
- 传输协议：udp
- 源区域：任意区域
- 源MAC地址：所有
- 源地址：所有
- 源端口：所有
- 目标区域：设备（输入）
- 目标地址：所有
- 目标端口：填写你配置接口使用的监听端口
- 动作：接受

这一步打开端口给所有地址连接

#### 测试连接

现在你可以试着用你的设备来连接openwrt上的WireGuard了

参照[单设备接入](/connect/single)

### 对等接入

你需要和他人的几个节点进行peer来接入DN11

DN11目前采用fullmesh，即全互联，所以目前建议与所有其他节点建立连接

::: tip
DN11仍处于早期阶段，后续会添加BGP（边缘网关协议），您的节点无需进行全互联。
:::

#### 添加他人的wireguard公钥

参照表格，将其他所有节点的信息填写进你的wireguard配置中

打开dn11的接口设置页面，往下翻，看到peers，单击添加

- 公钥：复制共享文档中的公钥
- 允许的IP：一般情况下，复制共享文档中的网段即可
- 路由允许的IP：勾选
- 端点主机：复制共享文档中的端点主机
- 端点端口：复制共享文档中的端点端口
- 持续Keep-Alive：一般为0，不用修改
- 预共享秘钥:忽略，除非对方使用了预共享秘钥，请在更多选项添加预共享秘钥并填写

::: tip
鉴于目前的体量，暂时使用人工操作，后续会采用autopeer避免繁杂易错的人工操作
:::

#### 将你的节点提供给他人连接

::: tip before
多数人都没有静态ip，请先参照[DDNS](/mics/ddns)配置动态域名解析
:::

将你的节点信息填写在共享表格中，公钥可以在`状态-WireGuard状态`看到

别的信息，相信你都做到这一步了没理由不知道怎么填写吧

#### 摇人

摇人，让他们添加你的节点信息
